# 头寸流程梳理

<!-- ![image-20220129174647855](../../img/image-20220129174647855.png) -->

[toc]
## 一、头寸基础

### 专业名词

* 头寸

* 敞口

  > 

* 损益

### 头寸品种

头寸品种：根据产品类型(`instrument`)、货币对(`pair`)、合约(`contract`)来判定。

| 大类   | 小类     |      |
| ------ | -------- | ---- |
| 外汇类 | 外汇     |      |
|        | 贵金属   |      |
|        | 积存金   |      |
|        | 品牌金   |      |
| 商品类 | 现货商品 |      |
|        | 期货商品 |      |

## 二、头寸业务流程

### 头寸接收

`交易模块`发送拆分后的头寸数据，头寸接收数据后进行如下几步操作：

1. `positionDealStep`:arrow_right:获取redis锁
2. `calculatePositionStep`:arrow_right:计算成本价、损益、敞口等
3. `cashFlowStep`:arrow_right:累计现金流
4. `makerPositionStep`:arrow_right: 做市商头寸累计
5. `calculatePositionRedisStep`:arrow_right:头寸累计数据存Redis
6. `pushPositionStep`:arrow_right:推送客户端
7. `pushMakerPositionStep`:arrow_right:推送做市商客户端
8. `calculatePositionFailStep`:arrow_right:累计头寸和现金流失败后执行
9. `positionReturnStep`:arrow_right:交易返回交易模块处理

`event`接收事件名称：

- `positionDealEvent` mq接收`Event`事件入口



### 头寸计算

实时对每个头寸的净敞口、成本价、已实现损益等进行实时的计算和累计。

根据产品类型(`instrument`)、货币对(`pair`)、合约(`contract`)来判定头寸品种.

需要计算出的`几个指标`:

- 成本价
- 货币一净敞口
- 货币二净敞口
- 浮动盈亏
- 已实现损益

#### 外汇/贵金属/积存金产品规则

外汇/贵金属/积存金产品计算规则如下：

1）敞口为`0`

```java
//成交价计算
成本价	=	成交价
//净敞口计算
货币一净敞口	=	货币一成交敞口
货币二净敞口	=	货币二成交敞口
//浮动盈亏
浮动盈亏	=	0
//已实现损益
已实现损益	=	0
```



```
```

2）标的方向不变

```javascript
//成本价计算
成本价	=	货币二敞口绝对值/货币一成交敞口绝对值
//净敞口计算
货币一净敞口	=	货币一成交敞口+货币一累计敞口
货币二净敞口	=	货币二成交敞口+货币二累计敞口
//浮动盈亏
浮动盈亏	=	（市价-成本价）*货币一敞口绝对值
//已实现损益
已实现损益	=	0
```



3）标的方向相反，但损益敞口方向不发生变化：

```javascript
//成本价计算
成本价=原成本价
//净敞口计算
货币一净敞口=货币一成交敞口+货币一累计敞口
货币二净敞口=货币二成交敞口+货币二累计敞口
//浮动盈亏
浮动盈亏=（市价-成本价）* 货币一敞口绝对值
//已实现损益
已实现损益=（成交价-成本价）* 货币一敞口绝对值
```



4）标的方向相反，但损益敞口方向发生变化：

```java
//成本价计算
成本价=成交价
//净敞口计算
货币一净敞口=货币一成交敞口+货币一累计敞口
货币二净敞口=货币二成交敞口+货币二累计敞口
//浮动盈亏
浮动盈亏=（市价-成本价）/货币一敞口绝对值=0
//已实现损益
已实现损益=（成交价-原成本价）*原货币一敞口绝对值
 
```



5）某一货币敞口为0：

```javascript
//成本价计算
成本价=0
//净敞口计算
货币一净敞口=货币一成交敞口+货币一累计敞口

货币二净敞口=货币二成交敞口+货币二累计敞口
//浮动盈亏
浮动盈亏=0
//已实现损益
已实现损益=（成交价-成本价）*敞口为0后的原货币敞口
```

**计算规则：**

|   字段条件   | 敞口为0                       | 标的方向不变                          | 标的方向相反，但损益敞口方向不发生变化 | 标的方向相反，但损益敞口方向发生变化   | 某一货币敞口为0                         |
| :----------: | ----------------------------- | ------------------------------------- | -------------------------------------- | -------------------------------------- | --------------------------------------- |
|    成本价    | 成交价                        | 货币二敞口绝对值/货币一成交敞口绝对值 | 货币二敞口绝对值/货币一成交敞口绝对值  | 成交价                                 | 0                                       |
| 货币一净敞口 | 货币一成交敞口+货币一累计敞口 |                                       |                                        |                                        |                                         |
| 货币二净敞口 | 货币二成交敞口+货币二累计敞口 |                                       |                                        |                                        |                                         |
|   浮动盈亏   | 0                             | （市价-成本价）*货币一敞口绝对值      | （市价-成本价）* 货币一敞口绝对值      | （市价-成本价）/货币一敞口绝对值=0     | 0                                       |
|  已实现损益  | 0                             | 0                                     | （成交价-成本价）* 货币一敞口绝对值    | （成交价-原成本价）*原货币一敞口绝对值 | （成交价-成本价）*敞口为0后的原货币敞口 |
|              |                               |                                       |                                        |                                        |                                         |

#### 品牌金规则

品牌金按照如下规则：



#### 现货和期货商品规则

现货和期货商品按照如下规则：



### 头寸监控

### 头寸快照
### 头寸快照重算
### 头寸平盘
### 头寸转移